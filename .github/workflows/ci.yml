# CI Pipeline
#
# Runs basic quality checks on every push and PR.
# Includes formatting, testing, and cleanup guard (via separate workflow).

name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration

  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Check code formatting
        run: npm run format:check

  typescript:
    name: TypeScript Build & Type Check
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Type check
        run: npm run prebuild

      - name: Build TypeScript
        run: npm run build

      - name: Verify compiled output
        run: |
          test -d dist
          test -f dist/cleanup/engine.js
          test -f dist/agent/cli.js

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Check for dead code (ts-prune)
        run: |
          echo "ðŸ” Checking for unused TypeScript code..."
          npm run deadcode || echo "ts-prune found unused code - review output above"

      - name: Check for unused dependencies (depcheck)
        run: |
          echo "ðŸ” Checking for unused dependencies..."
          npm run depcheck || echo "depcheck found unused dependencies - review output above"

  security-scan:
    name: Security & Supply Chain
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Generate SBOM
        run: |
          echo "ðŸ“¦ Generating Software Bill of Materials..."
          npm run sbom

      - name: Check for license compliance
        run: |
          echo "âš–ï¸ Checking license compliance..."
          # Basic license check - fail on copyleft licenses
          if npm ls --json | jq -r '.dependencies | keys[] as $k | .[$k] | select(.license == "GPL" or .license == "LGPL" or .license == "AGPL") | $k' | grep -q .; then
            echo "âŒ Found copyleft licenses - review dependencies"
            exit 1
          else
            echo "âœ… No problematic copyleft licenses found"
          fi

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

      - name: Run Gitleaks secret scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Semgrep SAST scan
        uses: semgrep/semgrep-action@v1
        with:
          config: auto

  plan-agent-guard:
    name: Plan/Agent Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for commit checking

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Check for context contracts
        id: check-context
        run: |
          if find . -name "context-*.json" | grep -q .; then
            echo "context_exists=true" >> $GITHUB_OUTPUT
            echo "context_files=$(find . -name "context-*.json" | tr '\n' ' ')" >> $GITHUB_OUTPUT
          else
            echo "context_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate context contracts
        if: steps.check-context.outputs.context_exists == 'true'
        run: |
          echo "ðŸ” Validating context contracts with Ajv..."
          node .github/tools/context-validate.js ${{ steps.check-context.outputs.context_files }}

      - name: Check for plan-only requirement
        id: check-plan-gate
        run: |
          # Check if STRICT_PLAN_GUARD is enabled and if this is a code-changing PR
          if [ "${{ vars.STRICT_PLAN_GUARD }}" = "true" ] && [ -n "$(git diff --name-only HEAD~1 | grep -E '\.(js|ts|tsx|jsx|py|java|go|rs)$')" ]; then
            echo "code_changes=true" >> $GITHUB_OUTPUT

            # Look for approved plan-only PR in recent commits or PR title
            if git log --oneline -20 | grep -q "plan-only\|implementation.*plan" || echo "${{ github.event.pull_request.title }}" | grep -q "plan-only\|implementation.*plan"; then
              echo "plan_pr_found=true" >> $GITHUB_OUTPUT
            else
              echo "plan_pr_found=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "code_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Enforce plan-only gate
        if: steps.check-plan-gate.outputs.code_changes == 'true' && steps.check-plan-gate.outputs.plan_pr_found == 'false'
        run: |
          echo "âŒ Code changes detected without approved plan-only PR"
          echo "ðŸ“‹ This PR contains code changes but no plan-only approval was found."
          echo ""
          echo "To fix this:"
          echo "1. Create a plan-only PR first using Cursor Plan Mode"
          echo "2. Get it approved and merged"
          echo "3. Reference the plan in your implementation PR"
          echo ""
          echo "ðŸ’¡ Set STRICT_PLAN_GUARD=false in repo variables to disable this check"
          exit 1

      - name: Generate impact predictions
        id: predict-impact
        if: steps.check-context.outputs.context_exists == 'true'
        run: |
          echo "ðŸŽ¯ Generating impact predictions..."
          node .github/tools/impact-predictor.js ${{ steps.check-context.outputs.context_files }} > impact-predictions.json
          echo "predictions_generated=true" >> $GITHUB_OUTPUT

      - name: Impact analysis validation
        if: steps.predict-impact.outputs.predictions_generated == 'true'
        run: |
          echo "ðŸ” Validating impact against predictions..."

          # Get actual changed files in this PR
          ACTUAL_FILES=$(git diff --name-only HEAD~1 | grep -E '\.(js|ts|tsx|jsx|py|java|go|rs|md)$' | tr '\n' ' ')

          echo "ðŸ“‹ Actual files changed: $ACTUAL_FILES"

          # Parse predictions from JSON
          PREDICTIONS=$(cat impact-predictions.json)

          # Check alignment based on IMPACT_GUARD level
          IMPACT_GUARD_LEVEL="${{ vars.IMPACT_GUARD }}"

          if [ "$IMPACT_GUARD_LEVEL" = "strict" ] || [ "$IMPACT_GUARD_LEVEL" = "block" ]; then
            echo "ðŸ” Strict impact validation enabled"

            # Use Node.js script for complex validation logic
            if node -e "
              const predictions = $PREDICTIONS;
              const actualFiles = '$ACTUAL_FILES'.split(' ').filter(f => f.trim());

              let allValid = true;
              const issues = [];

              predictions.forEach(pred => {
                const predictedFiles = pred.predictedFiles || [];
                console.log(\`ðŸ“‹ \${pred.contractId}: \${predictedFiles.length} predicted files\`);

                // Check for missing predictions
                const missing = predictedFiles.filter(p => !actualFiles.some(a => a.includes(p.split('/').pop()) || p.includes(a.split('/').pop())));
                if (missing.length > 0) {
                  issues.push(\`Missing predicted: \${missing.join(', ')}\`);
                  allValid = false;
                }

                // Check for unexpected files (allow tests, docs, config)
                const unexpected = actualFiles.filter(a =>
                  !predictedFiles.some(p => a.includes(p.split('/').pop()) || p.includes(a.split('/').pop())) &&
                  !a.match(/\.(test|spec)\.|README|CHANGELOG|package\.json|tsconfig\.json|\.md$/) &&
                  !a.startsWith('docs/') &&
                  !a.startsWith('scripts/')
                );
                if (unexpected.length > 0) {
                  issues.push(\`Unexpected files: \${unexpected.join(', ')}\`);
                  allValid = false;
                }
              });

              if (!allValid) {
                console.log('âŒ Impact validation FAILED:');
                issues.forEach(issue => console.log(\`   \${issue}\`));
                process.exit(1);
              } else {
                console.log('âœ… Impact validation PASSED');
              }
            "; then
              echo "âœ… Impact validation PASSED"
            else
              echo "âŒ Impact validation FAILED"
              exit 1
            fi

          elif [ "$IMPACT_GUARD_LEVEL" = "warn" ]; then
            echo "âš ï¸ Impact validation in warning mode"
            echo "â„¹ï¸ Validation warnings would appear here (not blocking)"

          else
            echo "â„¹ï¸ Impact validation disabled (set IMPACT_GUARD=warn or strict to enable)"
          fi

      - name: Upload impact predictions
        if: steps.predict-impact.outputs.predictions_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: impact-predictions
          path: impact-predictions.json

      - name: Log CI metrics
        if: always() && github.event_name == 'pull_request'
        run: |
          echo "ðŸ“Š Logging CI performance metrics..."
          # Pass context files and mock results (in real CI, results would be passed from previous steps)
          node .github/tools/metrics-log-ci.js ${{ steps.check-context.outputs.context_files || 'none' }}

      - name: Upload metrics artifact
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: ci-metrics
          path: metrics.jsonl

      - name: Assemble context pack for Plan Mode
        if: always() && github.event_name == 'pull_request'
        run: |
          echo "ðŸ“¦ Assembling context pack for Plan Mode..."
          node .github/tools/context-assemble-ci.js ${{ steps.check-context.outputs.context_files || 'none' }}

      - name: Upload context pack artifact
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: context-pack
          path: .contextpack/

      - name: Post Plan/Agent validation summary
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## ðŸ¤– DevEnvTemplate Plan/Agent Validation\n\n';

            // Determine validation status
            let contextStatus = 'âŒ No context contracts found';
            let planStatus = 'â„¹ï¸ Plan gate disabled';
            let impactStatus = 'â„¹ï¸ Impact validation disabled';

            // Check if context contracts exist (we can't easily check from here, so use basic logic)
            try {
              const contextFiles = fs.readdirSync('.').filter(f => f.startsWith('context-') && f.endsWith('.json'));
              if (contextFiles.length > 0) {
                contextStatus = 'âœ… Context contracts validated';
              }
            } catch (e) {
              // No context files
            }

            // Check plan gate status based on variables
            if (process.env.STRICT_PLAN_GUARD === 'true') {
              planStatus = 'âœ… Plan-only requirement enforced';
            }

            // Check impact validation status
            const impactLevel = process.env.IMPACT_GUARD;
            if (impactLevel === 'strict' || impactLevel === 'block') {
              impactStatus = 'ðŸ” Strict impact validation enabled';
            } else if (impactLevel === 'warn') {
              impactStatus = 'âš ï¸ Impact validation in warning mode';
            }

            comment += '### ðŸ“‹ Validation Summary\n\n';
            comment += `**Context Contracts:** ${contextStatus}\n`;
            comment += `**Plan-Only Gate:** ${planStatus}\n`;
            comment += `**Impact Analysis:** ${impactStatus}\n\n`;

            comment += '### ðŸŽ¯ Plan/Agent Workflow\n\n';
            comment += 'This PR was validated using the Plan/Agent-first approach:\n\n';
            comment += '1. **Plan Phase** (Cursor Plan Mode):\n';
            comment += '   - Create context contract defining the problem\n';
            comment += '   - Use Plan Mode to generate detailed implementation plan\n';
            comment += '   - Get plan approved via plan-only PR\n\n';

            comment += '2. **Agent Phase** (Implementation):\n';
            comment += '   - Execute approved plan using Cursor\n';
            comment += '   - Changes validated against plan predictions\n';
            comment += '   - Quality gates ensure code standards\n\n';

            comment += '### ðŸ“š Resources\n\n';
            comment += '- [Prompt Lifecycle Guide](docs/guides/prompt-lifecycle.md)\n';
            comment += '- [Cursor Plan Integration](docs/guides/cursor-plan-integration.md)\n';
            comment += '- [Plan Mode Snippets](docs/snippets/plan-mode/)\n\n';

            comment += '### âš™ï¸ Configuration\n\n';
            comment += 'Repository variables control enforcement:\n';
            comment += '- `STRICT_PLAN_GUARD=true` - Require plan-only PRs\n';
            comment += '- `IMPACT_GUARD=warn|strict` - Impact validation level\n\n';

            comment += '---\n\n';
            comment += '*Validation performed by DevEnvTemplate Plan/Agent CI guard*';

            // Post or update comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('DevEnvTemplate Plan/Agent Validation')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  release:
    name: Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    needs: [test, quality, typescript]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Create release PR or publish to npm
        id: changesets
        uses: changesets/action@v1
        with:
          publish: npm run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
