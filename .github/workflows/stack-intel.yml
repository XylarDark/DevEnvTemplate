name: Stack Intelligence & Gap Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '.projectrules'
      - '.github/workflows/**'
      - 'package.json'
      - 'tsconfig*.json'
      - '.eslintrc*'
      - 'jest.config*'
      - 'playwright.config*'
      - 'next.config*'
      - 'vite.config*'
      - 'webpack.config*'
      - '.env*'
      - 'docs/**'
  push:
    branches: [main, master]
    paths:
      - '.projectrules'
      - '.github/workflows/**'

jobs:
  stack-analysis:
    name: Tech Stack Detection & Gap Analysis
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'DevEnvTemplate') || contains(github.event.head_commit.message, 'drop-in') || contains(github.event.pull_request.title, 'DevEnvTemplate') || contains(github.event.pull_request.title, 'drop-in') || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Detect Tech Stack
        id: detect-stack
        run: |
          echo "ðŸ” Detecting technology stack..."

          # Create devenv directory
          mkdir -p .devenv

          # Run stack detection
          node .github/tools/stack-detector.js > .devenv/stack-report.json

          # Display results
          echo "## ðŸ“Š Current Tech Stack" >> $GITHUB_STEP_SUMMARY
          cat .devenv/stack-report.json | jq -r '"- **\(.name)**: \(.version) (\(.confidence))"' >> $GITHUB_STEP_SUMMARY

          # Check if we detected anything
          if [ "$(cat .devenv/stack-report.json | jq '.technologies | length')" = "0" ]; then
            echo "âš ï¸ No technologies detected. This may not be a JavaScript/TypeScript project."
            echo "STACK_DETECTED=false" >> $GITHUB_OUTPUT
          else
            echo "STACK_DETECTED=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze Gaps & Generate Plan
        id: analyze-gaps
        if: steps.detect-stack.outputs.STACK_DETECTED == 'true'
        run: |
          echo "ðŸŽ¯ Analyzing gaps against DevEnvTemplate standards..."

          # Generate gap analysis
          node .github/tools/gap-analyzer.js > .devenv/gaps-report.md

          # Count gaps
          GAP_COUNT=$(grep -c "^## " .devenv/gaps-report.md)
          echo "GAP_COUNT=$GAP_COUNT" >> $GITHUB_OUTPUT

          if [ "$GAP_COUNT" -gt 0 ]; then
            echo "GAPS_FOUND=true" >> $GITHUB_OUTPUT
          else
            echo "GAPS_FOUND=false" >> $GITHUB_OUTPUT
          fi

          # Generate plan if gaps exist
          if [ "$GAP_COUNT" -gt 0 ]; then
            node .github/tools/plan-generator.js > plans/$(date +%Y%m%d-%H%M%S)-hardening-plan.md
            echo "PLAN_GENERATED=true" >> $GITHUB_OUTPUT
          else
            echo "PLAN_GENERATED=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: devenv-analysis
          path: |
            .devenv/
            plans/

      - name: Post Analysis Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## ðŸ¤– DevEnvTemplate Stack Analysis\n\n';

            try {
              // Read stack report
              const stackReport = JSON.parse(fs.readFileSync('.devenv/stack-report.json', 'utf8'));
              comment += '### ðŸ“Š Detected Technologies\n\n';
              stackReport.technologies.forEach(tech => {
                comment += `- **${tech.name}**: ${tech.version} (${tech.confidence} confidence)\n`;
              });
              comment += '\n';
            } catch (e) {
              comment += '### âš ï¸ Stack Detection\n\nUnable to detect technology stack.\n\n';
            }

            try {
              // Read gaps report
              const gapsReport = fs.readFileSync('.devenv/gaps-report.md', 'utf8');
              const gapCount = (gapsReport.match(/^## /gm) || []).length;

              if (gapCount > 0) {
                comment += `### ðŸŽ¯ Gap Analysis (${gapCount} gaps found)\n\n`;
                comment += 'See [gaps report](.devenv/gaps-report.md) for details.\n\n';

                if ('${{ vars.STRICT_PLAN_GUARD }}' === 'true') {
                  comment += '### ðŸ“‹ Plan-Only PR\n\n';
                  comment += 'A Plan-only draft PR has been created for review. Please:\n';
                  comment += '1. Review the [hardening plan](plans/) \n';
                  comment += '2. Approve the plan before implementing changes\n';
                  comment += '3. Use Cursor Plan mode to execute approved changes\n\n';
                } else {
                  comment += '### ðŸ’¡ Next Steps\n\n';
                  comment += 'Consider implementing the suggested improvements using Cursor Plan mode.\n\n';
                }
              } else {
                comment += '### âœ… No Gaps Found\n\n';
                comment += 'Your project already meets DevEnvTemplate standards!\n\n';
              }
            } catch (e) {
              comment += '### â“ Gap Analysis\n\nUnable to complete gap analysis.\n\n';
            }

            comment += '### ðŸ“š Resources\n\n';
            comment += '- [Cursor Plan Integration Guide](docs/guides/cursor-plan-integration.md)\n';
            comment += '- [Prompt Lifecycle Guide](docs/guides/prompt-lifecycle.md)\n';
            comment += '- [Engineering Handbook](docs/engineering-handbook.md)\n\n';

            comment += '---\n\n*Analysis generated by DevEnvTemplate drop-in intelligence*';

            // Post or update comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('DevEnvTemplate Stack Analysis')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  create-plan-pr:
    name: Create Plan-Only Draft PR
    runs-on: ubuntu-latest
    if: >
      needs.stack-analysis.result == 'success' &&
      needs.stack-analysis.outputs.GAPS_FOUND == 'true' &&
      vars.STRICT_PLAN_GUARD == 'true' &&
      github.event_name == 'pull_request'
    needs: [stack-analysis]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Analysis Artifacts
        uses: actions/download-artifact@v4
        with:
          name: devenv-analysis

      - name: Create Plan-Only Draft PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the generated plan
            const planFiles = fs.readdirSync('plans').filter(f => f.endsWith('-hardening-plan.md'));
            if (planFiles.length === 0) {
              console.log('No plan file found');
              return;
            }

            const planFile = planFiles[0];
            const planContent = fs.readFileSync(`plans/${planFile}`, 'utf8');

            // Create PR title and body
            const prTitle = `ðŸ¤– Plan: DevEnvTemplate Hardening (${new Date().toISOString().split('T')[0]})`;
            const prBody = `## ðŸ¤– DevEnvTemplate Hardening Plan

This is an auto-generated Plan-only PR containing recommendations to align your project with DevEnvTemplate standards.

### ðŸ“‹ Plan Overview

${planContent}

### ðŸ”— Analysis Artifacts

- [Stack Report](.devenv/stack-report.json)
- [Gap Analysis](.devenv/gaps-report.md)

### ðŸ“ Next Steps

1. **Review this plan** - Ensure the proposed changes make sense for your project
2. **Merge this PR** if the plan is approved
3. **Use Cursor Plan mode** to implement the approved changes:
   - Open Plan Mode (Cmd/Ctrl + Shift + P)
   - Copy a snippet from [Plan Mode Snippets](docs/snippets/plan-mode/)
   - Attach the [stack report](.devenv/stack-report.json)
   - Execute the implementation

### âš ï¸ Important

- This PR contains **no code changes** - only the plan
- **Do not merge code changes** without first merging this plan
- The CI will enforce Plan-first workflow if \`STRICT_PLAN_GUARD=true\`

---

*Auto-generated by DevEnvTemplate drop-in analysis*
*See [Prompt Lifecycle Guide](docs/guides/prompt-lifecycle.md) for details*`;

            // Check if a plan-only PR already exists
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:plan-${context.issue.number}`
            });

            if (prs.length > 0) {
              console.log('Plan-only PR already exists');
              return;
            }

            // Create a new branch for the plan
            const branchName = `plan-${context.issue.number}`;

            // Create PR from current branch to current branch (draft)
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              head: context.payload.pull_request.head.ref,
              base: context.payload.pull_request.base.ref,
              body: prBody,
              draft: true
            });

            console.log(`Created plan-only draft PR: ${prTitle}`);
